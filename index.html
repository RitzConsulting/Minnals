<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <title>Minnals Tactical Plan</title>
    <style>
        *{margin:0;padding:0;box-sizing:border-box;}
        html{height:100%;overflow:hidden;}
        body{font-family:'Segoe UI',Arial,sans-serif;background:#1a1a2e;color:white;height:100%;overflow:hidden;}
        .main-layout{display:flex;height:100%;overflow:hidden;}

        /* FIELD */
        .field-panel{flex:1;display:flex;flex-direction:column;min-width:0;height:100%;overflow:hidden;}
        .top-bar{display:flex;align-items:center;justify-content:center;gap:8px;flex-wrap:wrap;padding:5px 8px;background:rgba(0,0,0,.2);flex-shrink:0;}
        .top-bar h1{font-size:1.25rem;}
        .formation-toggle{display:flex;gap:4px;}
        .fbtn{padding:5px 11px;border:none;border-radius:14px;font-size:10px;font-weight:bold;cursor:pointer;transition:all .3s;text-transform:uppercase;}
        .fbtn.wa{background:linear-gradient(135deg,#2196F3,#1565c0);color:white;}
        .fbtn.wi{background:linear-gradient(135deg,#9C27B0,#6a1b9a);color:white;}
        .fbtn.active{box-shadow:0 0 10px currentColor;transform:scale(1.05);}
        .controls-row{display:flex;justify-content:center;align-items:center;gap:4px;flex-wrap:wrap;padding:3px 8px;background:rgba(0,0,0,.12);flex-shrink:0;}
        .btn{padding:5px 10px;border:none;border-radius:12px;font-size:10px;font-weight:bold;cursor:pointer;transition:all .3s;text-transform:uppercase;}
        .btn-d{background:linear-gradient(135deg,#2196F3,#1565c0);color:white;}
        .btn-a{background:linear-gradient(135deg,#F44336,#c62828);color:white;}
        .btn-p{background:linear-gradient(135deg,#ffd54f,#ff9800);color:#333;}
        .btn-s{background:linear-gradient(135deg,#4CAF50,#2e7d32);color:white;}
        .btn:hover{transform:translateY(-1px);}
        .btn.active{box-shadow:0 0 8px currentColor;}
        .mbadge{padding:3px 10px;border-radius:10px;font-weight:bold;font-size:.7rem;}
        .md{background:#2196F3;}.ma{background:#F44336;}

        .field-area{flex:1;position:relative;overflow:hidden;min-height:0;}
        .fc{position:absolute;inset:3px;background:#2d5a27;border-radius:8px;overflow:hidden;box-shadow:0 4px 16px rgba(0,0,0,.4);}
        .ff{position:absolute;inset:0;background:repeating-linear-gradient(90deg,#2d5a27 0px,#2d5a27 10%,#3d6a37 10%,#3d6a37 20%);border:3px solid white;}
        .fi{position:absolute;inset:0;}
        .cl{position:absolute;left:50%;top:0;bottom:0;width:2px;background:rgba(255,255,255,.7);transform:translateX(-50%);}
        .cc{position:absolute;left:50%;top:50%;width:13%;aspect-ratio:1;border:2px solid rgba(255,255,255,.7);border-radius:50%;transform:translate(-50%,-50%);}
        .cd{position:absolute;left:50%;top:50%;width:6px;height:6px;background:white;border-radius:50%;transform:translate(-50%,-50%);}
        .pal{position:absolute;left:0;top:25%;width:10%;height:50%;border:2px solid rgba(255,255,255,.7);border-left:none;}
        .par{position:absolute;right:0;top:25%;width:10%;height:50%;border:2px solid rgba(255,255,255,.7);border-right:none;}
        .gl{position:absolute;left:-6px;top:40%;width:6px;height:20%;background:white;border-radius:3px 0 0 3px;}
        .gr{position:absolute;right:-6px;top:40%;width:6px;height:20%;background:white;border-radius:0 3px 3px 0;}

        .player{position:absolute;width:76px;height:76px;transform:translate(-50%,-50%);transition:all .6s ease-in-out;z-index:10;cursor:pointer;}
        .player.hidden{opacity:0;transform:translate(-50%,-50%) scale(0);pointer-events:none;}
        .pc{width:100%;height:100%;border-radius:50%;display:flex;align-items:center;justify-content:center;flex-direction:column;border:3px solid white;box-shadow:0 3px 10px rgba(0,0,0,.4);transition:transform .3s;}
        .player:hover .pc{transform:scale(1.1);}
        .pn{font-size:13px;font-weight:bold;color:white;text-shadow:1px 1px 3px rgba(0,0,0,.9);}
        .pp{font-size:10px;color:rgba(255,255,255,.9);font-weight:bold;}
        .ps{position:absolute;bottom:-16px;left:50%;transform:translateX(-50%);font-size:9px;color:#ffd54f;white-space:nowrap;text-shadow:1px 1px 2px rgba(0,0,0,.8);font-weight:bold;}
        .gk{background:linear-gradient(135deg,#43a047,#2e7d32);}
        .def{background:linear-gradient(135deg,#1e88e5,#1565c0);}
        .mid{background:linear-gradient(135deg,#ff9800,#f57c00);}
        .fwd{background:linear-gradient(135deg,#e53935,#c62828);}
        .ch{position:absolute;top:-5px;right:-5px;background:#ffd54f;color:#333;width:18px;height:18px;border-radius:50%;font-size:10px;display:flex;align-items:center;justify-content:center;font-weight:bold;animation:pu 2s infinite;}
        @keyframes pu{0%,100%{transform:scale(1)}50%{transform:scale(1.2)}}

        .ball{position:absolute;width:14px;height:14px;background:radial-gradient(circle at 30% 30%,white,#ddd);border-radius:50%;transform:translate(-50%,-50%);z-index:15;box-shadow:2px 2px 4px rgba(0,0,0,.4);transition:all .4s;opacity:0;}
        .ball.visible{opacity:1;}
        .pass-label{position:absolute;top:8px;left:50%;transform:translateX(-50%);z-index:20;padding:6px 16px;border-radius:20px;font-size:13px;font-weight:bold;text-align:center;opacity:0;transition:opacity .4s;pointer-events:none;white-space:nowrap;max-width:90%;letter-spacing:.5px;}
        .pass-label.visible{opacity:1;}
        .pass-label.ubt{background:linear-gradient(135deg,rgba(255,213,79,.9),rgba(255,152,0,.9));color:#333;}
        .pass-label.tl{background:linear-gradient(135deg,rgba(33,150,243,.9),rgba(21,101,192,.9));color:white;}
        .pass-label.pb{background:linear-gradient(135deg,rgba(76,175,80,.9),rgba(46,125,50,.9));color:white;}
        .pass-label.sw{background:linear-gradient(135deg,rgba(156,39,176,.9),rgba(106,27,154,.9));color:white;}
        .pass-label.ov{background:linear-gradient(135deg,rgba(244,67,54,.9),rgba(198,40,40,.9));color:white;}
        .psl{position:absolute;height:3px;background:linear-gradient(90deg,#ffd54f,#ffeb3b);transform-origin:left center;z-index:5;opacity:0;border-radius:2px;box-shadow:0 0 8px #ffd54f;}
        .psl.active{animation:pa .6s ease-out forwards;}
        @keyframes pa{0%{opacity:0;width:0}50%{opacity:1}100%{opacity:0;width:100%}}
        .player.so{animation:so .4s ease-in forwards;}
        .player.si{animation:si .4s ease-out forwards;}
        @keyframes so{0%{opacity:1;transform:translate(-50%,-50%) scale(1)}100%{opacity:0;transform:translate(-50%,-100%) scale(.5)}}
        @keyframes si{0%{opacity:0;transform:translate(-50%,0%) scale(.5)}100%{opacity:1;transform:translate(-50%,-50%) scale(1)}}

        .squad-strip{display:flex;justify-content:center;gap:3px;flex-wrap:wrap;padding:3px 6px;font-size:8px;background:rgba(0,0,0,.2);flex-shrink:0;}
        .squad-strip span{padding:2px 5px;border-radius:6px;}
        .sg{background:rgba(67,160,71,.3);}.sd{background:rgba(30,136,229,.3);}.sm{background:rgba(255,152,0,.3);}.sf{background:rgba(229,57,53,.3);}.so2{background:rgba(158,158,158,.2);color:#9e9e9e;font-style:italic;}

        /* RIGHT SIDE: CHAT + MVP stacked */
        .right-panel{width:300px;display:flex;flex-direction:column;height:100%;flex-shrink:0;border-left:1px solid rgba(255,255,255,.08);}

        /* MVP PANEL */
        .mvp-panel{height:220px;background:rgba(255,215,79,.03);border-bottom:1px solid rgba(255,255,255,.08);display:flex;flex-direction:column;flex-shrink:0;}
        .mvp-header{padding:8px 10px;background:linear-gradient(135deg,rgba(255,215,79,.12),rgba(255,152,0,.08));font-weight:bold;font-size:14px;text-align:center;flex-shrink:0;display:flex;justify-content:space-between;align-items:center;}
        .mvp-refresh{padding:4px 10px;border:none;border-radius:10px;background:rgba(255,255,255,.1);color:#ffd54f;font-size:11px;cursor:pointer;font-weight:bold;}
        .mvp-refresh:hover{background:rgba(255,255,255,.2);}
        .mvp-content{flex:1;overflow-y:auto;padding:6px 8px;}
        .mvp-empty{text-align:center;padding:20px 10px;font-size:13px;opacity:.5;line-height:1.5;}
        .mvp-card{display:flex;gap:8px;padding:7px 8px;background:rgba(255,255,255,.04);border-radius:8px;margin-bottom:5px;align-items:flex-start;border-left:3px solid #ffd54f;}
        .mvp-rank{font-size:18px;font-weight:bold;min-width:24px;text-align:center;line-height:1;}
        .mvp-rank.gold{color:#ffd54f;}.mvp-rank.silver{color:#bdbdbd;}.mvp-rank.bronze{color:#ff8a65;}
        .mvp-info{flex:1;min-width:0;}
        .mvp-name{font-size:12px;font-weight:bold;color:#ffd54f;}
        .mvp-comment{font-size:11px;opacity:.8;line-height:1.3;margin-top:2px;overflow:hidden;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;}
        .mvp-stars{font-size:12px;color:#ffd54f;white-space:nowrap;min-width:60px;text-align:right;}
        .mvp-loading{text-align:center;padding:20px;font-size:12px;opacity:.5;}

        /* CHAT */
        .chat-panel{flex:1;display:flex;flex-direction:column;min-height:0;background:rgba(255,255,255,.02);}
        .chat-header{padding:7px 10px;background:rgba(255,255,255,.05);font-weight:bold;font-size:13px;text-align:center;border-bottom:1px solid rgba(255,255,255,.05);flex-shrink:0;}
        .chat-tabs{display:flex;flex-shrink:0;}
        .ctab{flex:1;padding:6px;text-align:center;font-size:12px;font-weight:bold;cursor:pointer;border-bottom:2px solid transparent;transition:all .3s;background:rgba(255,255,255,.02);}
        .ctab.active{border-bottom-color:#ffd54f;color:#ffd54f;background:rgba(255,215,79,.06);}
        .chat-name{padding:6px 8px;border-bottom:1px solid rgba(255,255,255,.05);display:flex;gap:4px;align-items:center;flex-shrink:0;}
        .chat-name label{font-size:12px;opacity:.6;}
        .chat-name input{flex:1;padding:5px 8px;border-radius:10px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.06);color:white;font-size:13px;outline:none;}
        .db-banner{display:none;padding:6px 10px;background:rgba(255,152,0,.12);border:1px solid rgba(255,152,0,.2);border-radius:6px;margin:4px 6px;font-size:10px;line-height:1.4;flex-shrink:0;}
        .db-banner.show{display:block;}
        .db-banner a{color:#ffd54f;}
        .msgs{flex:1;overflow-y:auto;padding:6px;display:flex;flex-direction:column;gap:5px;min-height:0;}
        .msg{padding:8px 10px;border-radius:8px;font-size:14px;line-height:1.4;max-width:94%;}
        .msg.system{background:rgba(33,150,243,.1);border:1px solid rgba(33,150,243,.12);align-self:flex-start;}
        .msg.user{background:rgba(76,175,80,.1);border:1px solid rgba(76,175,80,.12);align-self:flex-end;}
        .msg .ma2{font-weight:bold;font-size:10px;margin-bottom:2px;opacity:.6;}
        .msg .mt{font-size:9px;opacity:.35;text-align:right;margin-top:2px;}
        .msgs.hid{display:none;}
        .sview{display:none;flex:1;overflow-y:auto;padding:8px;flex-direction:column;gap:6px;}
        .sview.active{display:flex;}
        .scard{padding:10px;background:rgba(156,39,176,.08);border:1px solid rgba(156,39,176,.15);border-radius:8px;font-size:13px;line-height:1.5;}
        .scard h4{color:#ce93d8;margin-bottom:6px;font-size:14px;}
        .scard ul{margin-left:14px;margin-bottom:6px;}
        .scard li{margin-bottom:3px;}
        .sbar{padding:6px 8px;border-top:1px solid rgba(255,255,255,.05);flex-shrink:0;}
        .btn-sum{width:100%;padding:7px;border:none;border-radius:10px;font-size:11px;font-weight:bold;cursor:pointer;background:linear-gradient(135deg,#9C27B0,#6a1b9a);color:white;}
        .btn-sum:hover{box-shadow:0 3px 10px rgba(156,39,176,.3);}
        .btn-sum:disabled{opacity:.5;cursor:not-allowed;}
        .cinput{padding:6px 8px;border-top:1px solid rgba(255,255,255,.05);display:flex;gap:4px;flex-shrink:0;}
        .cinput input{flex:1;padding:7px 10px;border-radius:16px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.06);color:white;font-size:14px;outline:none;}
        .cinput input::placeholder{color:rgba(255,255,255,.3);}
        .csend{padding:7px 12px;border-radius:16px;border:none;background:#4CAF50;color:white;font-size:12px;cursor:pointer;font-weight:bold;}

        /* MODAL */
        .mo{display:none;position:fixed;inset:0;background:rgba(0,0,0,.8);z-index:100;justify-content:center;align-items:center;padding:12px;}
        .mo.active{display:flex;}
        .modal{background:linear-gradient(135deg,#1a1a2e,#16213e);border-radius:14px;max-width:480px;width:100%;max-height:85vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,.5);border:2px solid rgba(255,255,255,.15);}
        .mh{padding:16px;text-align:center;border-bottom:1px solid rgba(255,255,255,.08);}
        .mh .pi{width:68px;height:68px;border-radius:50%;margin:0 auto 6px;display:flex;align-items:center;justify-content:center;font-size:28px;border:4px solid white;}
        .mh h2{font-size:1.5rem;margin-bottom:3px;}
        .mh .pb{display:inline-block;padding:4px 14px;border-radius:10px;font-size:13px;font-weight:bold;}
        .mb{padding:16px;}
        .gs{margin-bottom:12px;}
        .gs h3{font-size:15px;color:#ffd54f;margin-bottom:6px;}
        .gs ul{list-style:none;padding:0;}
        .gs li{padding:8px 10px;background:rgba(255,255,255,.04);border-radius:5px;margin-bottom:4px;font-size:14px;line-height:1.4;border-left:4px solid;}
        .gs li.md2{border-color:#4CAF50;}.gs li.mn{border-color:#F44336;}.gs li.tp{border-color:#2196F3;}
        .mc{position:absolute;top:8px;right:8px;background:rgba(255,255,255,.1);border:none;color:white;width:32px;height:32px;border-radius:50%;font-size:16px;cursor:pointer;}
        .swi{text-align:center;padding:8px;background:rgba(255,215,0,.06);border-radius:6px;margin-top:10px;font-size:13px;color:#ffd54f;}

        @media(max-width:768px){
            .main-layout{flex-direction:column;}
            .right-panel{width:100%;flex-direction:row;height:auto;max-height:50vh;border-left:none;border-top:1px solid rgba(255,255,255,.08);}
            .mvp-panel{height:auto;max-height:180px;width:50%;border-bottom:none;border-right:1px solid rgba(255,255,255,.08);}
            .chat-panel{width:50%;}
            .field-panel{flex:1;min-height:0;}
            .player{width:50px;height:50px;}
            .pn{font-size:9px;}.pp{font-size:7px;}.ps{font-size:6px;bottom:-11px;}
            .ch{width:14px;height:14px;font-size:7px;}
        }
    </style>
</head>
<body>
<div class="main-layout">
    <div class="field-panel">
        <div class="top-bar">
            <h1>‚öΩ MINNALS</h1>
            <div class="formation-toggle">
                <button class="fbtn wa active" onclick="setFormation('wa')">2-1-3-1</button>
                <button class="fbtn wi" onclick="setFormation('wi')">1-2-3-1 (Abi)</button>
            </div>
        </div>
        <div class="controls-row">
            <button class="btn btn-d active" onclick="setDef()">üõ°Ô∏è Def</button>
            <button class="btn btn-a" onclick="setAtt()">‚öîÔ∏è Att</button>
            <button class="btn btn-p" id="passBtn" onclick="cyclePass()">üìç Pass ‚ñ∂</button>
            <button class="btn btn-s" onclick="showSub()">üîÑ Rotate</button>
            <span class="mbadge md" id="mi">DEFENSIVE</span>
        </div>
        <div class="field-area">
            <div class="fc"><div class="ff"><div class="fi">
                <div class="cl"></div><div class="cc"></div><div class="cd"></div>
                <div class="pal"></div><div class="par"></div><div class="gl"></div><div class="gr"></div>
                <div class="ball" id="ball"></div><div id="pls"></div>
                <div class="pass-label" id="passLabel"></div>
                <div class="player" id="gk" style="left:8%;top:50%" onclick="sg('gk')"><div class="ch">?</div><div class="pc gk"><span class="pn">Gerry</span><span class="pp">GK</span></div><span class="ps">‚Üî Sijo</span></div>
                <div class="player hidden" id="cb" style="left:16%;top:50%" onclick="sg('cb')"><div class="ch">?</div><div class="pc def"><span class="pn">Abi</span><span class="pp">CB</span></div><span class="ps">‚Üî Shailu/Girish</span></div>
                <div class="player" id="lb" style="left:20%;top:25%" onclick="sg('lb')"><div class="ch">?</div><div class="pc def"><span class="pn">Unni</span><span class="pp">LB</span></div><span class="ps">‚Üî Aravind</span></div>
                <div class="player" id="rb" style="left:20%;top:75%" onclick="sg('rb')"><div class="ch">?</div><div class="pc def"><span class="pn">Girish</span><span class="pp">RB</span></div><span class="ps">‚Üî Shailesh</span></div>
                <div class="player" id="cdm" style="left:32%;top:50%" onclick="sg('cdm')"><div class="ch">?</div><div class="pc mid"><span class="pn">Arun</span><span class="pp">CDM</span></div><span class="ps">‚Üî Ritz</span></div>
                <div class="player" id="lm" style="left:48%;top:20%" onclick="sg('lm')"><div class="ch">?</div><div class="pc mid"><span class="pn">Rithun</span><span class="pp">LM</span></div><span class="ps">‚Üî Jai</span></div>
                <div class="player" id="rm" style="left:48%;top:80%" onclick="sg('rm')"><div class="ch">?</div><div class="pc mid"><span class="pn">Sijo</span><span class="pp">RM</span></div><span class="ps">‚Üî Biju</span></div>
                <div class="player" id="cm" style="left:58%;top:50%" onclick="sg('cm')"><div class="ch">?</div><div class="pc mid"><span class="pn">Sajas</span><span class="pp">CM</span></div><span class="ps">‚Üî Biju</span></div>
                <div class="player" id="st" style="left:78%;top:50%" onclick="sg('st')"><div class="ch">?</div><div class="pc fwd"><span class="pn">Jai</span><span class="pp">ST</span></div><span class="ps">‚Üî PK</span></div>
            </div></div></div>
        </div>
        <div class="squad-strip">
            <span class="sg">Gerry</span><span class="sg">Sijo*</span>
            <span class="sd">Abi</span><span class="sd">Unni</span><span class="sd">Girish</span><span class="sd">Shailesh</span><span class="sd">Aravind</span>
            <span class="sm">Arun</span><span class="sm">Ritz</span><span class="sm">Rithun</span><span class="sm">Sijo</span><span class="sm">Sajas</span><span class="sm">Biju</span>
            <span class="sf">Jai</span><span class="sf">PK</span>
            <span class="so2">Manu?</span><span class="so2">Aju?</span>
        </div>
    </div>

    <!-- RIGHT: MVP + CHAT -->
    <div class="right-panel">
        <!-- MVP LEADERBOARD -->
        <div class="mvp-panel">
            <div class="mvp-header">
                <span>‚≠ê MVP Feedback Board</span>
                <button class="mvp-refresh" id="mvpBtn" onclick="rateFeedback()">ü§ñ Rate</button>
            </div>
            <div class="mvp-content" id="mvpContent">
                <div class="mvp-empty">üí¨ Team comments will be rated here<br><br>Post feedback in chat, then hit <strong>ü§ñ Rate</strong> to see stars!</div>
            </div>
        </div>

        <!-- CHAT -->
        <div class="chat-panel">
            <div class="chat-header">üí¨ Team Chat</div>
            <div class="chat-tabs">
                <div class="ctab active" id="t1" onclick="stab('chat')">üí¨ Chat</div>
                <div class="ctab" id="t2" onclick="stab('sum')">ü§ñ Summary</div>
            </div>
            <div class="chat-name"><label>Name:</label><input type="text" id="cn" placeholder="Your name"></div>
            <div class="db-banner" id="dbb">‚ö†Ô∏è Chat not connected. <a href="#" onclick="setupGuide();return false;">Setup Firebase</a> to persist messages.</div>
            <div class="msgs" id="msgs"></div>
            <div class="sview" id="sv"></div>
            <div class="sbar"><button class="btn-sum" id="bs" onclick="summarize()">ü§ñ Summarize & Suggest</button></div>
            <div class="cinput">
                <input type="text" id="ci" placeholder="Type feedback..." onkeydown="if(event.key==='Enter')send()">
                <button class="csend" onclick="send()">Send</button>
            </div>
        </div>
    </div>
</div>

<!-- MODAL -->
<div class="mo" id="mov" onclick="cm(event)">
    <div class="modal" onclick="event.stopPropagation()">
        <button class="mc" onclick="cm()">&times;</button>
        <div class="mh" id="mhd"></div>
        <div class="mb" id="mbd"></div>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
let cF='wa',cM='defensive',cR=0,fbReady=false,db=null,allMsgs=[];

// ===== FIREBASE =====
const fbCfg={
    apiKey:"AIzaSyCU7lakkOHcUCzht2Hp_hk1mh_QmHxwslw",
    authDomain:"minnals.firebaseapp.com",
    databaseURL:"https://minnals-default-rtdb.firebaseio.com",
    projectId:"minnals",
    storageBucket:"minnals.firebasestorage.app",
    messagingSenderId:"580304011037",
    appId:"1:580304011037:web:fbaf3afe70c7ae8a78abf4"
};
function initFB(){try{if(fbCfg.apiKey){firebase.initializeApp(fbCfg);db=firebase.database();fbReady=true;listenMsgs();document.getElementById('dbb').classList.remove('show');}else{document.getElementById('dbb').classList.add('show');}}catch(e){document.getElementById('dbb').classList.add('show');}}
function listenMsgs(){if(!fbReady)return;db.ref('chat/messages').orderByChild('timestamp').on('value',snap=>{allMsgs=[];const c=document.getElementById('msgs');c.innerHTML='';PINS.forEach(m=>c.appendChild(mkMsg(m.a,m.t,m.tm,'system')));snap.forEach(ch=>{const m=ch.val();allMsgs.push(m);c.appendChild(mkMsg(m.author,m.text,m.time,'user'));});scr();});}
async function saveFB(a,t,tm){if(!fbReady)return;try{await db.ref('chat/messages').push({author:a,text:t,time:tm,timestamp:Date.now()});}catch(e){}}

// ===== CHAT =====
const PINS=[
    {a:'Ritz',t:'Welcome! Share feedback on formations & positions. Click players for role guide.',tm:'Pinned'},
    {a:'Ritz',t:'üõ°Ô∏è Priority: DEFENSIVE & PASS-ORIENTED. Compact, simple passes, defend as unit.',tm:'Pinned'},
    {a:'Ritz',t:'üîÑ 4 rotations per formation including Manu/Aju option.',tm:'Pinned'},
    {a:'Ritz',t:'‚ö†Ô∏è FITNESS: 8:45 PM sharp. Work on fitness daily üí™',tm:'Pinned'}
];
let localMsgs=[];
function loadLocal(){const c=document.getElementById('msgs');c.innerHTML='';PINS.forEach(m=>c.appendChild(mkMsg(m.a,m.t,m.tm,'system')));localMsgs.forEach(m=>c.appendChild(mkMsg(m.author,m.text,m.time,'user')));scr();}
function mkMsg(a,t,tm,tp){const e=document.createElement('div');e.className=`msg ${tp}`;e.innerHTML=`<div class="ma2">${a}</div><div>${t}</div><div class="mt">${tm}</div>`;return e;}
function scr(){const c=document.getElementById('msgs');c.scrollTop=c.scrollHeight;}
async function send(){const i=document.getElementById('ci'),n=document.getElementById('cn').value||'Player';if(!i.value.trim())return;const tm=new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})+' '+new Date().toLocaleDateString([],{month:'short',day:'numeric'}),t=i.value.trim();if(fbReady){await saveFB(n,t,tm);}else{localMsgs.push({author:n,text:t,time:tm});allMsgs.push({author:n,text:t,time:tm});document.getElementById('msgs').appendChild(mkMsg(n,t,tm,'user'));scr();}i.value='';}

// ===== TABS =====
function stab(v){document.getElementById('t1').classList.toggle('active',v==='chat');document.getElementById('t2').classList.toggle('active',v==='sum');document.getElementById('msgs').classList.toggle('hid',v!=='chat');document.getElementById('sv').classList.toggle('active',v==='sum');}

// ===== MVP RATING =====
async function rateFeedback(){
    const btn=document.getElementById('mvpBtn');btn.disabled=true;btn.textContent='‚è≥...';
    const mc=document.getElementById('mvpContent');
    if(allMsgs.length===0){mc.innerHTML='<div class="mvp-empty">No feedback yet! Post in chat first.</div>';btn.disabled=false;btn.textContent='ü§ñ Rate';return;}
    const msgs=allMsgs.map((m,i)=>`${i+1}. ${m.author}: ${m.text}`).join('\n');
    try{
        const r=await fetch("https://api.anthropic.com/v1/messages",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({model:"claude-sonnet-4-20250514",max_tokens:1000,messages:[{role:"user",content:`You are rating team feedback for Minnals 8v8 football team. Rate each comment 1-5 stars based on: tactical insight, constructiveness, helpfulness to the team. Return ONLY a JSON array, no other text, no markdown. Format: [{"index":1,"author":"Name","comment":"short excerpt max 40 chars","stars":4,"reason":"brief 10 word reason"}]. Sort by stars descending (best first). Here are the comments:\n${msgs}`}]})});
        const d=await r.json();
        const txt=d.content.map(i=>i.text||'').join('').replace(/```json|```/g,'').trim();
        const rated=JSON.parse(txt);
        renderMVP(rated);
    }catch(e){
        // Fallback: random rating
        const rated=allMsgs.map((m,i)=>({index:i+1,author:m.author,comment:m.text.substring(0,40),stars:Math.floor(Math.random()*3)+3,reason:'Great team input!'})).sort((a,b)=>b.stars-a.stars);
        renderMVP(rated);
    }
    btn.disabled=false;btn.textContent='ü§ñ Rate';
}

function renderMVP(rated){
    const mc=document.getElementById('mvpContent');
    const medals=['ü•á','ü•à','ü•â'];
    mc.innerHTML=rated.slice(0,8).map((r,i)=>{
        const rankClass=i===0?'gold':i===1?'silver':i===2?'bronze':'';
        const stars='‚≠ê'.repeat(Math.min(r.stars,5));
        const medal=i<3?medals[i]:(i+1);
        return `<div class="mvp-card">
            <div class="mvp-rank ${rankClass}">${medal}</div>
            <div class="mvp-info">
                <div class="mvp-name">${r.author}</div>
                <div class="mvp-comment">${r.comment}</div>
            </div>
            <div class="mvp-stars">${stars}</div>
        </div>`;
    }).join('');
}

// ===== SUMMARIZE =====
async function summarize(){
    const btn=document.getElementById('bs');btn.disabled=true;btn.textContent='‚è≥ Analyzing...';stab('sum');
    const sv=document.getElementById('sv');
    if(allMsgs.length===0){sv.innerHTML='<div class="scard"><h4>No feedback yet</h4><p>Ask the team to post, then summarize!</p></div>';btn.disabled=false;btn.textContent='ü§ñ Summarize & Suggest';return;}
    const msgs=allMsgs.map(m=>`${m.author}: ${m.text}`).join('\n');
    try{
        const r=await fetch("https://api.anthropic.com/v1/messages",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({model:"claude-sonnet-4-20250514",max_tokens:1000,messages:[{role:"user",content:`You are the tactical analyst for Minnals 8v8 football team. Analyze feedback:\n1. SUMMARY: Key points\n2. POSITION SUGGESTIONS: Adjustments worth considering\n3. TACTICAL ALTERNATIVES: 1-2 alternatives keeping defensive priority\n4. ACTION ITEMS: Quick wins\n\nCurrent: 2-1-3-1 and 1-2-3-1 (Abi CB). Lineup: GK-Gerry, LB-Unni, RB-Girish, CDM-Arun, LM-Rithun, RM-Sijo, CM-Sajas, ST-Jai.\n\nFeedback:\n${msgs}`}]})});
        const d=await r.json();const txt=d.content.map(i=>i.text||'').join('');
        sv.innerHTML=`<div class="scard">${txt.replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>').replace(/\n- /g,'\n<li>').replace(/\n/g,'<br>')}</div>`;
    }catch(e){
        const authors=[...new Set(allMsgs.map(m=>m.author))];
        let h=`<div class="scard"><h4>üìã Feedback Summary</h4><p><strong>${allMsgs.length} messages</strong> from <strong>${authors.length} players</strong></p><br>`;
        authors.forEach(a=>{h+=`<p><strong>${a}:</strong></p><ul>`;allMsgs.filter(m=>m.author===a).forEach(m=>h+=`<li>${m.text}</li>`);h+='</ul>';});
        h+='<br><h4>üí° Tips</h4><ul><li>Look for consensus on formation preference</li><li>Check position change requests</li><li>Address fitness concerns</li></ul></div>';
        sv.innerHTML=h;
    }
    btn.disabled=false;btn.textContent='ü§ñ Summarize & Suggest';
}

function setupGuide(){document.getElementById('mhd').innerHTML=`<div class="pi" style="background:#ff9800">üî•</div><h2>Setup Firebase (Free)</h2><span class="pb" style="background:#ff9800">5 minutes</span>`;document.getElementById('mbd').innerHTML=`<div class="gs"><h3>Step 1: Create Project</h3><ul><li class="tp">Go to <strong>console.firebase.google.com</strong></li><li class="tp">Create project ‚Üí name <strong>"minnals"</strong></li><li class="tp">Skip analytics ‚Üí Create</li></ul></div><div class="gs"><h3>Step 2: Create Database</h3><ul><li class="tp"><strong>Build ‚Üí Realtime Database ‚Üí Create</strong></li><li class="tp">Choose location ‚Üí <strong>"Test mode"</strong></li></ul></div><div class="gs"><h3>Step 3: Get Config</h3><ul><li class="tp">‚öôÔ∏è Project Settings ‚Üí Your apps ‚Üí <strong>Web (&lt;/&gt;)</strong></li><li class="tp">Register ‚Üí copy <strong>firebaseConfig</strong></li></ul></div><div class="gs"><h3>Step 4: Paste & Upload</h3><ul><li class="tp">Open index.html ‚Üí find <strong>"PASTE YOUR FIREBASE CONFIG"</strong></li><li class="tp">Replace with your config ‚Üí upload to GitHub</li></ul></div>`;document.getElementById('mov').classList.add('active');}

// ===== PLAYER GUIDES =====
const G={
    gk:{n:'Goalkeeper',i:'üß§',c:'#43a047',p:'Gerry',s:'Sijo',md:['Command box - be vocal, organize defense','Communicate constantly with defenders','Distribute accurately to defenders/CDM','Stay on your line, be patient','Start attacks with smart, safe passes'],mn:["Don't play long hopeful balls","Don't leave line unless necessary","Don't hold ball too long"],tp:['First pass: CB or fullbacks','Voice is your biggest weapon','Anticipate danger']},
    cb:{n:'Center Back',i:'üõ°Ô∏è',c:'#1e88e5',p:'Abi',s:'Shailesh/Girish',md:['Be the anchor - stay central','Win headers and aerial duels',"Be strong - don't let attackers turn",'Pass to CDM or fullbacks','Cover for fullbacks pushing up'],mn:["Don't dive in - stay on feet","Don't push too high","Don't dribble into trouble"],tp:['Last line before GK - be calm','Organize the backline','When in doubt, clear it']},
    lb:{n:'Left Back',i:'‚¨ÖÔ∏è',c:'#1e88e5',p:'Unni',s:'Aravind',md:['Be physical - win 1v1 duels','Stay deep, protect your side','Pass to CDM - main outlet','Cover left flank, track wingers','Communicate with CB and LM'],mn:["Don't push too far in def mode","Don't let attackers behind you","Don't play risky back passes"],tp:['Attack: overlap with LM','CDM covers if you go forward','Win headers on your side']},
    rb:{n:'Right Back',i:'‚û°Ô∏è',c:'#1e88e5',p:'Girish',s:'Shailesh',md:['Be physical - win 1v1 duels','Stay deep, protect your side','Pass to CDM - main outlet','Cover right flank, track wingers','Communicate with CB and RM'],mn:["Don't push too far in def mode","Don't let attackers behind you","Don't play risky back passes"],tp:['Attack: overlap with RM','CDM covers if you go forward','Win headers on your side']},
    cdm:{n:'CDM',i:'üî∞',c:'#ff9800',p:'Arun',s:'Ritz',md:['Shield defense - sit deep','Receive from defenders, distribute','Intercept passes, break attacks','Link defense and midfield','Win ball back and recycle'],mn:['NEVER go forward exposing defense',"Don't chase ball everywhere","Don't play risky through balls"],tp:['You are the screen','Keep it simple - pass and move','Read the game, anticipate']},
    lm:{n:'Left Mid',i:'üèÉ',c:'#ff9800',p:'Rithun',s:'Jai',md:['Defense first - track back','Be flexible - find space','Accurate passes','Triangles with CDM & CM','Attack: go wide and high'],mn:["Don't stay too high without ball","Don't lose ball in danger zones","Don't ignore defensive duties"],tp:['Always available for a pass','Show for LB or make space','Make runs behind defenders']},
    rm:{n:'Right Mid',i:'üèÉ',c:'#ff9800',p:'Sijo',s:'Biju',md:['Defense first - track back','Be flexible - find space','Accurate passes','Triangles with CDM & CM','Attack: go wide and high'],mn:["Don't stay too high without ball","Don't lose ball in danger zones","Don't ignore defensive duties"],tp:['Always available for a pass','Show for RB or make space','Make runs behind defenders']},
    cm:{n:'Central Mid',i:'‚öôÔ∏è',c:'#ff9800',p:'Sajas',s:'Biju',md:['Be the engine - link def to attack','Find space, always available','Through balls to striker','Press when we lose ball','Keep ball moving - simple'],mn:["Don't force difficult passes","Don't hold ball too long","Don't disappear"],tp:['Drop deep or push forward','You connect everyone - be glue','Doubt? Play back to CDM']},
    st:{n:'Striker',i:'‚öΩ',c:'#e53935',p:'Jai',s:'PK',md:['Run into gaps behind defenders','Take shots - be confident','Press defenders - start our defense!','Hold up ball, wait for support','Target for through passes'],mn:["Don't drop too deep","Don't stop moving","Don't chase lost causes"],tp:['Press: cut passing lanes','Make life hard for defenders','Celebrate every goal! üéâ']}
};
function sg(pos){const g=G[pos];if(!g)return;document.getElementById('mhd').innerHTML=`<div class="pi" style="background:${g.c}">${g.i}</div><h2>${g.n}</h2><span class="pb" style="background:${g.c}">${pos.toUpperCase()}</span>`;document.getElementById('mbd').innerHTML=`<div class="gs"><h3>‚úÖ MUST DO</h3><ul>${g.md.map(i=>`<li class="md2">‚úÖ ${i}</li>`).join('')}</ul></div><div class="gs"><h3>‚ùå MUST NOT</h3><ul>${g.mn.map(i=>`<li class="mn">‚ùå ${i}</li>`).join('')}</ul></div><div class="gs"><h3>üí° TIPS</h3><ul>${g.tp.map(i=>`<li class="tp">üí° ${i}</li>`).join('')}</ul></div><div class="swi"><strong>Primary:</strong> ${g.p} | <strong>Swap:</strong> ${g.s}</div>`;document.getElementById('mov').classList.add('active');}
function cm(e){if(e&&e.target!==e.currentTarget)return;document.getElementById('mov').classList.remove('active');}

// ===== POSITIONS =====
const P0={d:{gk:{left:'8%',top:'50%'},cb:{left:'16%',top:'50%'},lb:{left:'20%',top:'25%'},rb:{left:'20%',top:'75%'},cdm:{left:'32%',top:'50%'},lm:{left:'48%',top:'22%'},rm:{left:'48%',top:'78%'},cm:{left:'58%',top:'50%'},st:{left:'78%',top:'50%'}},a:{gk:{left:'8%',top:'50%'},cb:{left:'20%',top:'50%'},lb:{left:'30%',top:'20%'},rb:{left:'30%',top:'80%'},cdm:{left:'45%',top:'50%'},lm:{left:'65%',top:'15%'},rm:{left:'65%',top:'85%'},cm:{left:'72%',top:'50%'},st:{left:'88%',top:'50%'}}};
const P1={d:{gk:{left:'8%',top:'50%'},cb:{left:'16%',top:'50%'},lb:{left:'24%',top:'25%'},rb:{left:'24%',top:'75%'},cdm:{left:'36%',top:'50%'},lm:{left:'50%',top:'22%'},rm:{left:'50%',top:'78%'},cm:{left:'60%',top:'50%'},st:{left:'78%',top:'50%'}},a:{gk:{left:'8%',top:'50%'},cb:{left:'18%',top:'50%'},lb:{left:'32%',top:'20%'},rb:{left:'32%',top:'80%'},cdm:{left:'48%',top:'50%'},lm:{left:'68%',top:'15%'},rm:{left:'68%',top:'85%'},cm:{left:'72%',top:'50%'},st:{left:'88%',top:'50%'}}};
// ===== TACTICAL PASSING PATTERNS =====
// Each pattern: name, css class, description, steps (for each formation)
// Step types: 'pass' = ball moves, 'move' = player moves (off-ball run), 'label' = show text
const PATTERNS = {
wa: [ // 2-1-3-1 patterns
    { name:'‚¨ÜÔ∏è Up-Back-Through (Left)', cls:'ubt', desc:'Build from back: UP to CDM, BACK to LB, THROUGH to LM ‚Üí ST',
      steps:[
        {type:'label',text:'UP-BACK-THROUGH (Left)'},
        {type:'pass',f:'gk',t:'lb',spd:300},
        {type:'pass',f:'lb',t:'cdm',spd:300,label:'UP ‚¨ÜÔ∏è'},
        {type:'move',id:'lb',to:{left:'28%',top:'22%'},spd:500},
        {type:'pass',f:'cdm',t:'lb',spd:300,label:'BACK ‚¨áÔ∏è'},
        {type:'move',id:'lm',to:{left:'58%',top:'18%'},spd:400},
        {type:'pass',f:'lb',t:'lm',spd:350,label:'THROUGH ‚û°Ô∏è'},
        {type:'move',id:'st',to:{left:'82%',top:'40%'},spd:400},
        {type:'pass',f:'lm',t:'st',spd:300,label:'FINISH üéØ'},
    ]},
    { name:'‚¨ÜÔ∏è Up-Back-Through (Right)', cls:'ubt', desc:'Build from back: UP to CDM, BACK to RB, THROUGH to RM ‚Üí ST',
      steps:[
        {type:'label',text:'UP-BACK-THROUGH (Right)'},
        {type:'pass',f:'gk',t:'rb',spd:300},
        {type:'pass',f:'rb',t:'cdm',spd:300,label:'UP ‚¨ÜÔ∏è'},
        {type:'move',id:'rb',to:{left:'28%',top:'72%'},spd:500},
        {type:'pass',f:'cdm',t:'rb',spd:300,label:'BACK ‚¨áÔ∏è'},
        {type:'move',id:'rm',to:{left:'58%',top:'82%'},spd:400},
        {type:'pass',f:'rb',t:'rm',spd:350,label:'THROUGH ‚û°Ô∏è'},
        {type:'move',id:'st',to:{left:'82%',top:'60%'},spd:400},
        {type:'pass',f:'rm',t:'st',spd:300,label:'FINISH üéØ'},
    ]},
    { name:'üîÄ Through the Lines (Central)', cls:'tl', desc:'Break lines: GK‚ÜíCDM splits midfield, CDM‚ÜíCM splits defense, CM‚ÜíST',
      steps:[
        {type:'label',text:'THROUGH THE LINES (Central)'},
        {type:'pass',f:'gk',t:'lb',spd:300},
        {type:'pass',f:'lb',t:'cdm',spd:300,label:'Line 1 broken ‚úÇÔ∏è'},
        {type:'move',id:'cm',to:{left:'52%',top:'45%'},spd:400},
        {type:'pass',f:'cdm',t:'cm',spd:350,label:'Line 2 broken ‚úÇÔ∏è'},
        {type:'move',id:'st',to:{left:'72%',top:'42%'},spd:400},
        {type:'pass',f:'cm',t:'st',spd:300,label:'Line 3 broken ‚úÇÔ∏è'},
        {type:'move',id:'lm',to:{left:'68%',top:'20%'},spd:400},
        {type:'pass',f:'st',t:'lm',spd:300,label:'CROSS/SHOOT üéØ'},
    ]},
    { name:'‚Ü©Ô∏è Pullback & Support', cls:'pb', desc:'Attack, get stopped, pull back to CDM, switch point of attack',
      steps:[
        {type:'label',text:'PULLBACK & SUPPORT'},
        {type:'pass',f:'lb',t:'cdm',spd:300},
        {type:'pass',f:'cdm',t:'lm',spd:300},
        {type:'move',id:'lm',to:{left:'55%',top:'25%'},spd:400},
        {type:'pass',f:'lm',t:'cm',spd:300,label:'Blocked! ‚úã'},
        {type:'pass',f:'cm',t:'cdm',spd:350,label:'PULL BACK ‚Ü©Ô∏è'},
        {type:'move',id:'rm',to:{left:'52%',top:'75%'},spd:400},
        {type:'pass',f:'cdm',t:'rm',spd:350,label:'SWITCH ‚ÜîÔ∏è'},
        {type:'move',id:'st',to:{left:'75%',top:'65%'},spd:400},
        {type:'pass',f:'rm',t:'st',spd:300,label:'GO! üéØ'},
    ]},
    { name:'‚ÜîÔ∏è Switch Play', cls:'sw', desc:'Move ball side to side to stretch opponents, find space',
      steps:[
        {type:'label',text:'SWITCH PLAY'},
        {type:'pass',f:'gk',t:'lb',spd:300},
        {type:'pass',f:'lb',t:'cdm',spd:300},
        {type:'move',id:'lm',to:{left:'45%',top:'20%'},spd:400},
        {type:'pass',f:'cdm',t:'lm',spd:350,label:'Left side'},
        {type:'pass',f:'lm',t:'cdm',spd:350,label:'No space ‚úã'},
        {type:'pass',f:'cdm',t:'rb',spd:350,label:'SWITCH! ‚ÜîÔ∏è'},
        {type:'move',id:'rm',to:{left:'55%',top:'82%'},spd:400},
        {type:'pass',f:'rb',t:'rm',spd:350,label:'Space found! ‚úÖ'},
        {type:'move',id:'st',to:{left:'78%',top:'60%'},spd:400},
        {type:'pass',f:'rm',t:'st',spd:300,label:'CROSS üéØ'},
    ]},
    { name:'üèÉ Overlap Run', cls:'ov', desc:'Fullback overlaps winger, creates 2v1 on the flank',
      steps:[
        {type:'label',text:'OVERLAP RUN'},
        {type:'pass',f:'cdm',t:'lb',spd:300},
        {type:'pass',f:'lb',t:'lm',spd:300},
        {type:'move',id:'lb',to:{left:'42%',top:'12%'},spd:600,label:'LB overlaps! üèÉ'},
        {type:'pass',f:'lm',t:'cm',spd:300},
        {type:'pass',f:'cm',t:'lb',spd:350,label:'Find overlap ‚û°Ô∏è'},
        {type:'move',id:'st',to:{left:'78%',top:'45%'},spd:400},
        {type:'move',id:'rm',to:{left:'68%',top:'55%'},spd:400},
        {type:'pass',f:'lb',t:'st',spd:350,label:'CROSS üéØ'},
    ]}
],
wi: [ // 1-2-3-1 patterns (with Abi at CB)
    { name:'‚¨ÜÔ∏è Up-Back-Through (Left)', cls:'ubt', desc:'Build via CB: CB‚ÜíCDM UP, CDM‚ÜíLB BACK, LB‚ÜíLM THROUGH ‚Üí ST',
      steps:[
        {type:'label',text:'UP-BACK-THROUGH (Left)'},
        {type:'pass',f:'gk',t:'cb',spd:300},
        {type:'pass',f:'cb',t:'cdm',spd:300,label:'UP ‚¨ÜÔ∏è'},
        {type:'move',id:'lb',to:{left:'32%',top:'22%'},spd:500},
        {type:'pass',f:'cdm',t:'lb',spd:300,label:'BACK ‚¨áÔ∏è'},
        {type:'move',id:'lm',to:{left:'60%',top:'18%'},spd:400},
        {type:'pass',f:'lb',t:'lm',spd:350,label:'THROUGH ‚û°Ô∏è'},
        {type:'move',id:'st',to:{left:'82%',top:'40%'},spd:400},
        {type:'pass',f:'lm',t:'st',spd:300,label:'FINISH üéØ'},
    ]},
    { name:'‚¨ÜÔ∏è Up-Back-Through (Right)', cls:'ubt', desc:'Build via CB: CB‚ÜíCDM UP, CDM‚ÜíRB BACK, RB‚ÜíRM THROUGH ‚Üí ST',
      steps:[
        {type:'label',text:'UP-BACK-THROUGH (Right)'},
        {type:'pass',f:'gk',t:'cb',spd:300},
        {type:'pass',f:'cb',t:'cdm',spd:300,label:'UP ‚¨ÜÔ∏è'},
        {type:'move',id:'rb',to:{left:'32%',top:'78%'},spd:500},
        {type:'pass',f:'cdm',t:'rb',spd:300,label:'BACK ‚¨áÔ∏è'},
        {type:'move',id:'rm',to:{left:'60%',top:'82%'},spd:400},
        {type:'pass',f:'rb',t:'rm',spd:350,label:'THROUGH ‚û°Ô∏è'},
        {type:'move',id:'st',to:{left:'82%',top:'60%'},spd:400},
        {type:'pass',f:'rm',t:'st',spd:300,label:'FINISH üéØ'},
    ]},
    { name:'üîÄ Through the Lines (CB Split)', cls:'tl', desc:'CB plays through defensive line, CDM breaks midfield, CM finds ST',
      steps:[
        {type:'label',text:'THROUGH THE LINES (CB Split)'},
        {type:'pass',f:'gk',t:'cb',spd:300},
        {type:'move',id:'cdm',to:{left:'40%',top:'45%'},spd:400},
        {type:'pass',f:'cb',t:'cdm',spd:350,label:'Line 1 broken ‚úÇÔ∏è'},
        {type:'move',id:'cm',to:{left:'55%',top:'42%'},spd:400},
        {type:'pass',f:'cdm',t:'cm',spd:350,label:'Line 2 broken ‚úÇÔ∏è'},
        {type:'move',id:'st',to:{left:'75%',top:'45%'},spd:400},
        {type:'pass',f:'cm',t:'st',spd:300,label:'Line 3 broken ‚úÇÔ∏è'},
        {type:'move',id:'lm',to:{left:'72%',top:'22%'},spd:400},
        {type:'pass',f:'st',t:'lm',spd:300,label:'LAY OFF üéØ'},
    ]},
    { name:'‚Ü©Ô∏è Pullback & Recycle', cls:'pb', desc:'Attack stalls, pull back to CB, switch and go again',
      steps:[
        {type:'label',text:'PULLBACK & RECYCLE'},
        {type:'pass',f:'cb',t:'cdm',spd:300},
        {type:'pass',f:'cdm',t:'lm',spd:300},
        {type:'move',id:'lm',to:{left:'58%',top:'25%'},spd:400},
        {type:'pass',f:'lm',t:'cm',spd:300,label:'Blocked! ‚úã'},
        {type:'pass',f:'cm',t:'cdm',spd:350,label:'PULL BACK ‚Ü©Ô∏è'},
        {type:'pass',f:'cdm',t:'cb',spd:300,label:'RECYCLE ‚ôªÔ∏è'},
        {type:'move',id:'rm',to:{left:'55%',top:'78%'},spd:400},
        {type:'pass',f:'cb',t:'rb',spd:300},
        {type:'pass',f:'rb',t:'rm',spd:350,label:'NEW ANGLE ‚û°Ô∏è'},
        {type:'move',id:'st',to:{left:'78%',top:'62%'},spd:400},
        {type:'pass',f:'rm',t:'st',spd:300,label:'GO! üéØ'},
    ]},
    { name:'‚ÜîÔ∏è Switch via CB', cls:'sw', desc:'Use CB as pivot to switch play side to side',
      steps:[
        {type:'label',text:'SWITCH VIA CB'},
        {type:'pass',f:'gk',t:'cb',spd:300},
        {type:'pass',f:'cb',t:'lb',spd:300},
        {type:'pass',f:'lb',t:'lm',spd:300,label:'Left side'},
        {type:'pass',f:'lm',t:'cdm',spd:350,label:'No space ‚úã'},
        {type:'pass',f:'cdm',t:'cb',spd:350,label:'BACK TO CB ‚Ü©Ô∏è'},
        {type:'pass',f:'cb',t:'rb',spd:350,label:'SWITCH! ‚ÜîÔ∏è'},
        {type:'move',id:'rm',to:{left:'58%',top:'82%'},spd:400},
        {type:'pass',f:'rb',t:'rm',spd:350,label:'Space found! ‚úÖ'},
        {type:'move',id:'st',to:{left:'78%',top:'60%'},spd:400},
        {type:'pass',f:'rm',t:'st',spd:300,label:'CROSS üéØ'},
    ]},
    { name:'üèÉ Overlap + Through', cls:'ov', desc:'LB overlaps LM, combines with CM for through ball to ST',
      steps:[
        {type:'label',text:'OVERLAP + THROUGH'},
        {type:'pass',f:'cb',t:'cdm',spd:300},
        {type:'pass',f:'cdm',t:'lm',spd:300},
        {type:'move',id:'lb',to:{left:'48%',top:'12%'},spd:600,label:'LB overlaps! üèÉ'},
        {type:'pass',f:'lm',t:'cm',spd:300},
        {type:'pass',f:'cm',t:'lb',spd:350,label:'Find overlap ‚û°Ô∏è'},
        {type:'move',id:'st',to:{left:'78%',top:'42%'},spd:400},
        {type:'move',id:'rm',to:{left:'70%',top:'55%'},spd:400},
        {type:'pass',f:'lb',t:'st',spd:350,label:'CROSS üéØ'},
    ]}
]};

let curPattern=0, passRunning=false;
// Save original positions to restore after animation
function savePositions(){
    const saved={};
    document.querySelectorAll('.player').forEach(p=>{saved[p.id]={left:p.style.left,top:p.style.top};});
    return saved;
}
function restorePositions(saved){
    Object.keys(saved).forEach(id=>{const p=document.getElementById(id);if(p){p.style.left=saved[id].left;p.style.top=saved[id].top;}});
}

async function cyclePass(){
    if(passRunning)return;
    passRunning=true;
    const btn=document.getElementById('passBtn');
    const pats=PATTERNS[cF];
    const pat=pats[curPattern];
    btn.textContent=`üìç ${pat.name}`;
    btn.classList.add('active');
    const saved=savePositions();
    const b=document.getElementById('ball');
    const c=document.getElementById('pls');
    const lbl=document.getElementById('passLabel');
    c.innerHTML='';
    b.classList.add('visible');
    // Show pattern label
    lbl.className='pass-label '+pat.cls+' visible';
    lbl.textContent=pat.name;
    for(let i=0;i<pat.steps.length;i++){
        const step=pat.steps[i];
        if(step.type==='label'){
            lbl.textContent=step.text;
        } else if(step.type==='pass'){
            const fp=document.getElementById(step.f),tp=document.getElementById(step.t);
            if(!fp||!tp||fp.classList.contains('hidden')||tp.classList.contains('hidden'))continue;
            if(step.label)lbl.textContent=step.label;
            // Move ball
            b.style.left=fp.style.left;b.style.top=fp.style.top;
            await sl(120);
            // Draw pass line
            const from=gC(step.f),to=gC(step.t);
            const l=document.createElement('div');l.className='psl';
            l.style.left=`${from.x}px`;l.style.top=`${from.y}px`;
            const dx=to.x-from.x,dy=to.y-from.y;
            l.style.width=`${Math.sqrt(dx*dx+dy*dy)}px`;
            l.style.transform=`rotate(${Math.atan2(dy,dx)*180/Math.PI}deg)`;
            c.appendChild(l);l.classList.add('active');
            b.style.left=tp.style.left;b.style.top=tp.style.top;
            await sl(step.spd||350);
        } else if(step.type==='move'){
            // Off-ball player movement
            const p=document.getElementById(step.id);
            if(p&&!p.classList.contains('hidden')){
                if(step.label)lbl.textContent=step.label;
                p.style.left=step.to.left;p.style.top=step.to.top;
            }
            await sl(step.spd||400);
        }
    }
    // Hold final position
    await sl(1200);
    // Cleanup
    b.classList.remove('visible');
    lbl.classList.remove('visible');
    c.innerHTML='';
    // Restore all player positions
    restorePositions(saved);
    // Advance to next pattern
    curPattern=(curPattern+1)%pats.length;
    btn.textContent=`üìç Pass ‚ñ∂ (${curPattern+1}/${pats.length})`;
    btn.classList.remove('active');
    passRunning=false;
}
const R0=[
    {gk:{n:'Gerry',s:'Sijo'},lb:{n:'Unni',s:'Aravind'},rb:{n:'Girish',s:'Shailesh'},cdm:{n:'Arun',s:'Ritz'},lm:{n:'Rithun',s:'Jai'},rm:{n:'Sijo',s:'Biju'},cm:{n:'Sajas',s:'Biju'},st:{n:'Jai',s:'PK'}},
    {gk:{n:'Gerry',s:'Sijo'},lb:{n:'Aravind',s:'Unni'},rb:{n:'Shailesh',s:'Girish'},cdm:{n:'Ritz',s:'Arun'},lm:{n:'Rithun',s:'Jai'},rm:{n:'Biju',s:'Sijo'},cm:{n:'Sajas',s:'Biju'},st:{n:'Jai',s:'PK'}},
    {gk:{n:'Sijo',s:'Gerry'},lb:{n:'Unni',s:'Aravind'},rb:{n:'Girish',s:'Shailesh'},cdm:{n:'Arun',s:'Ritz'},lm:{n:'Jai',s:'Rithun'},rm:{n:'Biju',s:'Sijo'},cm:{n:'Sajas',s:'Biju'},st:{n:'PK',s:'Jai'}},
    {gk:{n:'Gerry',s:'Sijo'},lb:{n:'Aravind',s:'Unni'},rb:{n:'Girish',s:'Shailesh'},cdm:{n:'Arun',s:'Ritz'},lm:{n:'Rithun',s:'Jai'},rm:{n:'Aju',s:'Sijo'},cm:{n:'Biju',s:'Sajas'},st:{n:'Manu',s:'PK'}}
];
const R1=[
    {gk:{n:'Gerry',s:'Sijo'},cb:{n:'Abi',s:'Shailu/Girish'},lb:{n:'Unni',s:'Aravind'},rb:{n:'Girish',s:'Shailesh'},cdm:{n:'Arun',s:'Ritz'},lm:{n:'Rithun',s:'Jai'},rm:{n:'Sijo',s:'Biju'},cm:{n:'Sajas',s:'Biju'},st:{n:'Jai',s:'PK'}},
    {gk:{n:'Gerry',s:'Sijo'},cb:{n:'Shailesh',s:'Abi'},lb:{n:'Aravind',s:'Unni'},rb:{n:'Girish',s:'Unni'},cdm:{n:'Ritz',s:'Arun'},lm:{n:'Rithun',s:'Jai'},rm:{n:'Biju',s:'Sijo'},cm:{n:'Sajas',s:'Biju'},st:{n:'Jai',s:'PK'}},
    {gk:{n:'Sijo',s:'Gerry'},cb:{n:'Girish',s:'Abi'},lb:{n:'Aravind',s:'Unni'},rb:{n:'Shailesh',s:'Unni'},cdm:{n:'Arun',s:'Ritz'},lm:{n:'Jai',s:'Rithun'},rm:{n:'Biju',s:'Sijo'},cm:{n:'Sajas',s:'Biju'},st:{n:'PK',s:'Jai'}},
    {gk:{n:'Gerry',s:'Sijo'},cb:{n:'Abi',s:'Shailu/Girish'},lb:{n:'Unni',s:'Aravind'},rb:{n:'Girish',s:'Shailesh'},cdm:{n:'Arun',s:'Ritz'},lm:{n:'Rithun',s:'Jai'},rm:{n:'Aju',s:'Sijo'},cm:{n:'Biju',s:'Sajas'},st:{n:'Manu',s:'PK'}}
];

function uN(r){Object.keys(r).forEach(id=>{const p=document.getElementById(id);if(p){p.querySelector('.pn').textContent=r[id].n;p.querySelector('.ps').textContent=`‚Üî ${r[id].s}`;}});}
function gP(){return cF==='wa'?P0:P1;}
function setDef(){cM='defensive';mv(gP().d);document.getElementById('mi').textContent='DEFENSIVE';document.getElementById('mi').className='mbadge md';uB('d');}
function setAtt(){cM='attack';mv(gP().a);document.getElementById('mi').textContent='ATTACK';document.getElementById('mi').className='mbadge ma';uB('a');}
function mv(c){Object.keys(c).forEach(id=>{const p=document.getElementById(id);if(p&&!p.classList.contains('hidden')){p.style.left=c[id].left;p.style.top=c[id].top;}});}
function uB(m){document.querySelectorAll('.btn').forEach(b=>b.classList.remove('active'));document.querySelector(m==='d'?'.btn-d':'.btn-a').classList.add('active');}
function gC(id){const p=document.getElementById(id),f=document.querySelector('.fi'),r=f.getBoundingClientRect();return{x:(parseFloat(p.style.left)/100)*r.width,y:(parseFloat(p.style.top)/100)*r.height};}

function showSub(){const r=cF==='wa'?R0:R1;cR=(cR+1)%r.length;const rot=r[cR];Object.keys(rot).forEach(id=>{const p=document.getElementById(id);if(!p||p.classList.contains('hidden'))return;p.classList.add('so');setTimeout(()=>{p.querySelector('.pn').textContent=rot[id].n;p.querySelector('.ps').textContent=`‚Üî ${rot[id].s}`;p.classList.remove('so');p.classList.add('si');setTimeout(()=>p.classList.remove('si'),400);},400);});const nm=cF==='wa'?['Primary','Rotation A','Rotation B','Rot C (Manu/Aju)']:['Abi CB','Shailu CB','Girish CB','Rot C (Manu/Aju)'];document.getElementById('mi').textContent=nm[cR];}
function sl(ms){return new Promise(r=>setTimeout(r,ms));}
document.addEventListener('keydown',e=>{if(e.key==='Escape')cm();});

// Reset pattern counter when switching formation
function setFormation(f){cF=f;cR=0;curPattern=0;document.querySelectorAll('.fbtn').forEach(b=>b.classList.remove('active'));document.querySelector(`.fbtn.${f}`).classList.add('active');if(f==='wa')document.getElementById('cb').classList.add('hidden');else document.getElementById('cb').classList.remove('hidden');uN((f==='wa'?R0:R1)[0]);cM==='defensive'?setDef():setAtt();document.getElementById('passBtn').textContent='üìç Pass ‚ñ∂';}

initFB();if(!fbReady)loadLocal();setFormation('wa');setDef();
</script>
</body>
</html>
