<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <title>Minnals Tactical Plan</title>
    <style>
        *{margin:0;padding:0;box-sizing:border-box;}
        html{height:100%;overflow:hidden;}
        body{font-family:'Segoe UI',Arial,sans-serif;background:#1a1a2e;color:white;height:100%;overflow:hidden;display:flex;flex-direction:column;}

        .main-layout{display:flex;flex:1;overflow:hidden;width:100%;height:100%;}

        /* FIELD PANEL */
        .field-panel{flex:1;display:flex;flex-direction:column;min-width:0;height:100%;overflow:hidden;}

        .top-bar{display:flex;align-items:center;justify-content:center;gap:8px;flex-wrap:wrap;padding:6px 8px;background:rgba(0,0,0,.2);flex-shrink:0;}
        .top-bar h1{font-size:1.3rem;}
        .formation-toggle{display:flex;gap:5px;}
        .formation-btn{padding:6px 12px;border:none;border-radius:16px;font-size:10px;font-weight:bold;cursor:pointer;transition:all .3s;text-transform:uppercase;}
        .formation-btn.without-abi{background:linear-gradient(135deg,#2196F3,#1565c0);color:white;}
        .formation-btn.with-abi{background:linear-gradient(135deg,#9C27B0,#6a1b9a);color:white;}
        .formation-btn.active{box-shadow:0 0 12px currentColor;transform:scale(1.05);}

        .controls-row{display:flex;justify-content:center;align-items:center;gap:5px;flex-wrap:wrap;padding:4px 8px;background:rgba(0,0,0,.15);flex-shrink:0;}
        .btn{padding:5px 12px;border:none;border-radius:14px;font-size:10px;font-weight:bold;cursor:pointer;transition:all .3s;text-transform:uppercase;}
        .btn-defensive{background:linear-gradient(135deg,#2196F3,#1565c0);color:white;}
        .btn-attack{background:linear-gradient(135deg,#F44336,#c62828);color:white;}
        .btn-pass{background:linear-gradient(135deg,#ffd54f,#ff9800);color:#333;}
        .btn-sub{background:linear-gradient(135deg,#4CAF50,#2e7d32);color:white;}
        .btn:hover{transform:translateY(-1px);}
        .btn.active{box-shadow:0 0 10px currentColor;}
        .mode-badge{padding:4px 12px;border-radius:12px;font-weight:bold;font-size:.75rem;}
        .mode-defensive{background:#2196F3;}
        .mode-attack{background:#F44336;}

        /* FIELD - takes all remaining space */
        .field-area{flex:1;position:relative;overflow:hidden;min-height:0;}
        .field-container{position:absolute;inset:4px;background:#2d5a27;border-radius:8px;overflow:hidden;box-shadow:0 6px 20px rgba(0,0,0,.4);}
        .field{position:absolute;inset:0;background:repeating-linear-gradient(90deg,#2d5a27 0px,#2d5a27 10%,#3d6a37 10%,#3d6a37 20%);border:3px solid white;}
        .field-inner{position:absolute;inset:0;}
        .center-line{position:absolute;left:50%;top:0;bottom:0;width:2px;background:rgba(255,255,255,.7);transform:translateX(-50%);}
        .center-circle{position:absolute;left:50%;top:50%;width:14%;aspect-ratio:1;border:2px solid rgba(255,255,255,.7);border-radius:50%;transform:translate(-50%,-50%);}
        .center-dot{position:absolute;left:50%;top:50%;width:6px;height:6px;background:white;border-radius:50%;transform:translate(-50%,-50%);}
        .penalty-area-left{position:absolute;left:0;top:25%;width:10%;height:50%;border:2px solid rgba(255,255,255,.7);border-left:none;}
        .penalty-area-right{position:absolute;right:0;top:25%;width:10%;height:50%;border:2px solid rgba(255,255,255,.7);border-right:none;}
        .goal-left{position:absolute;left:-6px;top:40%;width:6px;height:20%;background:white;border-radius:3px 0 0 3px;}
        .goal-right{position:absolute;right:-6px;top:40%;width:6px;height:20%;background:white;border-radius:0 3px 3px 0;}

        .player{position:absolute;width:80px;height:80px;transform:translate(-50%,-50%);transition:all .6s ease-in-out;z-index:10;cursor:pointer;}
        .player.hidden{opacity:0;transform:translate(-50%,-50%) scale(0);pointer-events:none;}
        .player-circle{width:100%;height:100%;border-radius:50%;display:flex;align-items:center;justify-content:center;flex-direction:column;border:3px solid white;box-shadow:0 3px 12px rgba(0,0,0,.4);transition:transform .3s;}
        .player:hover .player-circle{transform:scale(1.12);}
        .player-name{font-size:14px;font-weight:bold;color:white;text-shadow:1px 1px 3px rgba(0,0,0,.9);}
        .player-pos{font-size:11px;color:rgba(255,255,255,.9);font-weight:bold;}
        .player-swap{position:absolute;bottom:-18px;left:50%;transform:translateX(-50%);font-size:10px;color:#ffd54f;white-space:nowrap;text-shadow:1px 1px 2px rgba(0,0,0,.8);font-weight:bold;}
        .gk{background:linear-gradient(135deg,#43a047,#2e7d32);}
        .def{background:linear-gradient(135deg,#1e88e5,#1565c0);}
        .mid{background:linear-gradient(135deg,#ff9800,#f57c00);}
        .fwd{background:linear-gradient(135deg,#e53935,#c62828);}
        .click-hint{position:absolute;top:-6px;right:-6px;background:#ffd54f;color:#333;width:20px;height:20px;border-radius:50%;font-size:11px;display:flex;align-items:center;justify-content:center;font-weight:bold;animation:pulse 2s infinite;}
        @keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.2)}}

        .ball{position:absolute;width:16px;height:16px;background:radial-gradient(circle at 30% 30%,white,#ddd);border-radius:50%;transform:translate(-50%,-50%);z-index:15;box-shadow:2px 2px 5px rgba(0,0,0,.4);transition:all .4s ease-in-out;opacity:0;}
        .ball.visible{opacity:1;}
        .pass-line{position:absolute;height:3px;background:linear-gradient(90deg,#ffd54f,#ffeb3b);transform-origin:left center;z-index:5;opacity:0;border-radius:2px;box-shadow:0 0 8px #ffd54f;}
        .pass-line.active{animation:passAnim .6s ease-out forwards;}
        @keyframes passAnim{0%{opacity:0;width:0}50%{opacity:1}100%{opacity:0;width:100%}}

        .player.subbing-out{animation:subOut .4s ease-in forwards;}
        .player.subbing-in{animation:subIn .4s ease-out forwards;}
        @keyframes subOut{0%{opacity:1;transform:translate(-50%,-50%) scale(1)}100%{opacity:0;transform:translate(-50%,-100%) scale(.5)}}
        @keyframes subIn{0%{opacity:0;transform:translate(-50%,0%) scale(.5)}100%{opacity:1;transform:translate(-50%,-50%) scale(1)}}

        /* Squad strip */
        .squad-strip{display:flex;justify-content:center;gap:4px;flex-wrap:wrap;padding:4px 6px;font-size:9px;background:rgba(0,0,0,.2);flex-shrink:0;}
        .squad-strip span{padding:2px 6px;border-radius:8px;}
        .sq-gk{background:rgba(67,160,71,.3);}.sq-def{background:rgba(30,136,229,.3);}.sq-mid{background:rgba(255,152,0,.3);}.sq-fwd{background:rgba(229,57,53,.3);}.sq-opt{background:rgba(158,158,158,.2);color:#9e9e9e;font-style:italic;}

        /* CHAT PANEL */
        .chat-panel{width:260px;background:rgba(255,255,255,.03);border-left:1px solid rgba(255,255,255,.08);display:flex;flex-direction:column;height:100%;flex-shrink:0;}
        .chat-header{padding:8px;background:rgba(255,255,255,.06);font-weight:bold;font-size:12px;text-align:center;border-bottom:1px solid rgba(255,255,255,.06);flex-shrink:0;}
        .chat-name-input{padding:6px 8px;border-bottom:1px solid rgba(255,255,255,.06);display:flex;gap:4px;align-items:center;flex-shrink:0;}
        .chat-name-input label{font-size:10px;opacity:.6;}
        .chat-name-input input{flex:1;padding:4px 8px;border-radius:10px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.06);color:white;font-size:10px;outline:none;}
        .chat-messages{flex:1;overflow-y:auto;padding:6px;display:flex;flex-direction:column;gap:5px;min-height:0;}
        .chat-msg{padding:6px 9px;border-radius:8px;font-size:11px;line-height:1.35;max-width:94%;}
        .chat-msg.system{background:rgba(33,150,243,.12);border:1px solid rgba(33,150,243,.15);align-self:flex-start;}
        .chat-msg.user{background:rgba(76,175,80,.12);border:1px solid rgba(76,175,80,.15);align-self:flex-end;}
        .chat-msg .msg-author{font-weight:bold;font-size:9px;margin-bottom:2px;opacity:.6;}
        .chat-msg .msg-time{font-size:8px;opacity:.4;text-align:right;margin-top:2px;}
        .chat-input-area{padding:6px 8px;border-top:1px solid rgba(255,255,255,.06);display:flex;gap:4px;flex-shrink:0;}
        .chat-input-area input{flex:1;padding:6px 10px;border-radius:16px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.06);color:white;font-size:11px;outline:none;}
        .chat-input-area input::placeholder{color:rgba(255,255,255,.3);}
        .chat-send{padding:6px 12px;border-radius:16px;border:none;background:#4CAF50;color:white;font-size:11px;cursor:pointer;font-weight:bold;}
        .chat-send:hover{background:#388E3C;}
        .chat-loading{text-align:center;padding:10px;font-size:11px;opacity:.5;}

        /* MODAL */
        .modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.8);z-index:100;justify-content:center;align-items:center;padding:15px;}
        .modal-overlay.active{display:flex;}
        .modal{background:linear-gradient(135deg,#1a1a2e,#16213e);border-radius:14px;max-width:400px;width:100%;max-height:80vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,.5);border:2px solid rgba(255,255,255,.15);}
        .modal-header{padding:14px;text-align:center;border-bottom:1px solid rgba(255,255,255,.08);}
        .modal-header .player-icon{width:54px;height:54px;border-radius:50%;margin:0 auto 6px;display:flex;align-items:center;justify-content:center;font-size:20px;border:3px solid white;}
        .modal-header h2{font-size:1.15rem;margin-bottom:3px;}
        .modal-header .position-badge{display:inline-block;padding:3px 10px;border-radius:10px;font-size:10px;font-weight:bold;}
        .modal-body{padding:14px;}
        .guide-section{margin-bottom:10px;}
        .guide-section h3{font-size:11px;color:#ffd54f;margin-bottom:4px;}
        .guide-section ul{list-style:none;padding:0;}
        .guide-section li{padding:5px 8px;background:rgba(255,255,255,.04);border-radius:5px;margin-bottom:3px;font-size:11px;line-height:1.35;border-left:3px solid;}
        .guide-section li.must-do{border-color:#4CAF50;}.guide-section li.must-not{border-color:#F44336;}.guide-section li.tip{border-color:#2196F3;}
        .modal-close{position:absolute;top:8px;right:8px;background:rgba(255,255,255,.1);border:none;color:white;width:28px;height:28px;border-radius:50%;font-size:15px;cursor:pointer;}
        .swap-info{text-align:center;padding:6px;background:rgba(255,215,0,.08);border-radius:6px;margin-top:8px;font-size:10px;color:#ffd54f;}

        @media(max-width:700px){
            .main-layout{flex-direction:column;}
            .chat-panel{width:100%;height:200px;border-left:none;border-top:1px solid rgba(255,255,255,.08);flex-shrink:0;}
            .field-panel{flex:1;min-height:0;}
            .player{width:56px;height:56px;}
            .player-name{font-size:10px;}.player-pos{font-size:8px;}.player-swap{font-size:7px;bottom:-13px;}
            .click-hint{width:16px;height:16px;font-size:8px;}
        }
    </style>
</head>
<body>
<div class="main-layout">
    <div class="field-panel">
        <div class="top-bar">
            <h1>‚öΩ MINNALS</h1>
            <div class="formation-toggle">
                <button class="formation-btn without-abi active" onclick="setFormation('without-abi')">2-1-3-1</button>
                <button class="formation-btn with-abi" onclick="setFormation('with-abi')">1-2-3-1 (Abi)</button>
            </div>
        </div>
        <div class="controls-row">
            <button class="btn btn-defensive active" onclick="setDefensiveMode()">üõ°Ô∏è Def</button>
            <button class="btn btn-attack" onclick="setAttackMode()">‚öîÔ∏è Att</button>
            <button class="btn btn-pass" onclick="showPassingPattern()">üìç Pass</button>
            <button class="btn btn-sub" onclick="showSubstitution()">üîÑ Rotate</button>
            <span class="mode-badge mode-defensive" id="modeIndicator">DEFENSIVE</span>
        </div>

        <div class="field-area">
            <div class="field-container">
                <div class="field">
                    <div class="field-inner">
                        <div class="center-line"></div>
                        <div class="center-circle"></div>
                        <div class="center-dot"></div>
                        <div class="penalty-area-left"></div>
                        <div class="penalty-area-right"></div>
                        <div class="goal-left"></div>
                        <div class="goal-right"></div>
                        <div class="ball" id="ball"></div>
                        <div id="passLines"></div>

                        <div class="player" id="gk" style="left:8%;top:50%" onclick="showPlayerGuide('gk')"><div class="click-hint">?</div><div class="player-circle gk"><span class="player-name">Gerry</span><span class="player-pos">GK</span></div><span class="player-swap">‚Üî Sijo</span></div>
                        <div class="player hidden" id="cb" style="left:16%;top:50%" onclick="showPlayerGuide('cb')"><div class="click-hint">?</div><div class="player-circle def"><span class="player-name">Abi</span><span class="player-pos">CB</span></div><span class="player-swap">‚Üî Shailu/Girish</span></div>
                        <div class="player" id="lb" style="left:20%;top:25%" onclick="showPlayerGuide('lb')"><div class="click-hint">?</div><div class="player-circle def"><span class="player-name">Unni</span><span class="player-pos">LB</span></div><span class="player-swap">‚Üî Aravind</span></div>
                        <div class="player" id="rb" style="left:20%;top:75%" onclick="showPlayerGuide('rb')"><div class="click-hint">?</div><div class="player-circle def"><span class="player-name">Girish</span><span class="player-pos">RB</span></div><span class="player-swap">‚Üî Shailesh</span></div>
                        <div class="player" id="cdm" style="left:32%;top:50%" onclick="showPlayerGuide('cdm')"><div class="click-hint">?</div><div class="player-circle mid"><span class="player-name">Arun</span><span class="player-pos">CDM</span></div><span class="player-swap">‚Üî Ritz</span></div>
                        <div class="player" id="lm" style="left:48%;top:20%" onclick="showPlayerGuide('lm')"><div class="click-hint">?</div><div class="player-circle mid"><span class="player-name">Rithun</span><span class="player-pos">LM</span></div><span class="player-swap">‚Üî Jai</span></div>
                        <div class="player" id="rm" style="left:48%;top:80%" onclick="showPlayerGuide('rm')"><div class="click-hint">?</div><div class="player-circle mid"><span class="player-name">Sijo</span><span class="player-pos">RM</span></div><span class="player-swap">‚Üî Biju</span></div>
                        <div class="player" id="cm" style="left:58%;top:50%" onclick="showPlayerGuide('cm')"><div class="click-hint">?</div><div class="player-circle mid"><span class="player-name">Sajas</span><span class="player-pos">CM</span></div><span class="player-swap">‚Üî Biju</span></div>
                        <div class="player" id="st" style="left:78%;top:50%" onclick="showPlayerGuide('st')"><div class="click-hint">?</div><div class="player-circle fwd"><span class="player-name">Jai</span><span class="player-pos">ST</span></div><span class="player-swap">‚Üî PK</span></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="squad-strip">
            <span class="sq-gk">Gerry</span><span class="sq-gk">Sijo*</span>
            <span class="sq-def">Abi</span><span class="sq-def">Unni</span><span class="sq-def">Girish</span><span class="sq-def">Shailesh</span><span class="sq-def">Aravind</span>
            <span class="sq-mid">Arun</span><span class="sq-mid">Ritz</span><span class="sq-mid">Rithun</span><span class="sq-mid">Sijo</span><span class="sq-mid">Sajas</span><span class="sq-mid">Biju</span>
            <span class="sq-fwd">Jai</span><span class="sq-fwd">PK</span>
            <span class="sq-opt">Manu?</span><span class="sq-opt">Aju?</span>
        </div>
    </div>

    <div class="chat-panel">
        <div class="chat-header">üí¨ Team Feedback</div>
        <div class="chat-name-input"><label>Name:</label><input type="text" id="chatName" placeholder="Your name"></div>
        <div class="chat-messages" id="chatMessages"></div>
        <div class="chat-input-area">
            <input type="text" id="chatInput" placeholder="Type feedback..." onkeydown="if(event.key==='Enter')sendChat()">
            <button class="chat-send" onclick="sendChat()">Send</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="modalOverlay" onclick="closeModal(event)">
    <div class="modal" onclick="event.stopPropagation()">
        <button class="modal-close" onclick="closeModal()">&times;</button>
        <div class="modal-header" id="modalHeader"></div>
        <div class="modal-body" id="modalBody"></div>
    </div>
</div>

<script>
let currentFormation='without-abi',currentMode='defensive',currentRotation=0;

// ===== PERSISTENT CHAT STORAGE =====
const CHAT_KEY = 'minnals-team-chat';
const PINNED_MSGS = [
    {author:'Ritz',text:'Welcome! Share feedback on formations & positions. Click any player for their role guide.',time:'Pinned',type:'system'},
    {author:'Ritz',text:'üõ°Ô∏è Priority: DEFENSIVE & PASS-ORIENTED. Stay compact, simple passes, defend as a unit.',time:'Pinned',type:'system'},
    {author:'Ritz',text:'üîÑ 4 rotations: Primary ‚Üí Rot A ‚Üí Rot B ‚Üí Rot C (Manu/Aju)',time:'Pinned',type:'system'},
    {author:'Ritz',text:'‚ö†Ô∏è FITNESS: 8:45 PM sharp. Work on fitness daily üí™',time:'Pinned',type:'system'}
];

let storageAvailable = false;
let localMessages = []; // fallback in-memory store

async function checkStorage() {
    try {
        if (window.storage && typeof window.storage.get === 'function') {
            storageAvailable = true;
        }
    } catch(e) {
        storageAvailable = false;
    }
}

async function loadChat() {
    const container = document.getElementById('chatMessages');
    container.innerHTML = '';

    // Always render pinned first
    PINNED_MSGS.forEach(m => {
        container.appendChild(makeMsgEl(m.author, m.text, m.time, m.type));
    });

    // Try shared storage first, then personal, then in-memory
    let msgs = [];
    if (storageAvailable) {
        try {
            const result = await window.storage.get(CHAT_KEY, true);
            msgs = JSON.parse(result.value);
        } catch(e1) {
            try {
                const result = await window.storage.get(CHAT_KEY, false);
                msgs = JSON.parse(result.value);
            } catch(e2) {
                msgs = localMessages;
            }
        }
    } else {
        msgs = localMessages;
    }

    if (Array.isArray(msgs)) {
        msgs.forEach(m => {
            container.appendChild(makeMsgEl(m.author, m.text, m.time, 'user'));
        });
    }
    scrollChat();
}

async function saveChat(author, text, time) {
    const newMsg = {author, text, time};
    localMessages.push(newMsg);

    if (!storageAvailable) return;

    let msgs = [];
    // Try to load existing
    try {
        const result = await window.storage.get(CHAT_KEY, true);
        msgs = JSON.parse(result.value);
        if (!Array.isArray(msgs)) msgs = [];
    } catch(e1) {
        try {
            const result = await window.storage.get(CHAT_KEY, false);
            msgs = JSON.parse(result.value);
            if (!Array.isArray(msgs)) msgs = [];
        } catch(e2) {
            msgs = [...localMessages];
        }
    }

    if (!msgs.find(m => m.author === newMsg.author && m.text === newMsg.text && m.time === newMsg.time)) {
        msgs.push(newMsg);
    }
    if (msgs.length > 100) msgs = msgs.slice(-100);

    // Try shared first, fallback to personal
    try {
        await window.storage.set(CHAT_KEY, JSON.stringify(msgs), true);
    } catch(e1) {
        try {
            await window.storage.set(CHAT_KEY, JSON.stringify(msgs), false);
        } catch(e2) {
            // storage unavailable, in-memory only
        }
    }
}

function makeMsgEl(author, text, time, type) {
    const el = document.createElement('div');
    el.className = `chat-msg ${type}`;
    el.innerHTML = `<div class="msg-author">${author}</div><div>${text}</div><div class="msg-time">${time}</div>`;
    return el;
}

function scrollChat() {
    const c = document.getElementById('chatMessages');
    c.scrollTop = c.scrollHeight;
}

async function sendChat() {
    const input = document.getElementById('chatInput');
    const name = document.getElementById('chatName').value || 'Player';
    if (!input.value.trim()) return;
    const t = new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}) + ' ' + new Date().toLocaleDateString([], {month:'short',day:'numeric'});
    const text = input.value.trim();

    // Add to UI
    document.getElementById('chatMessages').appendChild(makeMsgEl(name, text, t, 'user'));
    scrollChat();
    input.value = '';

    // Save to persistent shared storage
    await saveChat(name, text, t);
}

// Chat refresh handled at init

// ===== PLAYER GUIDES =====
const playerGuides={
    gk:{name:'Goalkeeper',icon:'üß§',color:'#43a047',primary:'Gerry',swap:'Sijo',mustDo:['Command your box - be vocal and organize defense','Communicate constantly with defenders','Distribute accurately to defenders or CDM','Stay on your line, be patient','Start attacks with smart, safe passes'],mustNot:["Don't play long hopeful balls","Don't leave your line unless necessary","Don't hold the ball too long under pressure"],tips:['First pass option: CB or fullbacks','Your voice is your biggest weapon','Watch the game and anticipate danger']},
    cb:{name:'Center Back',icon:'üõ°Ô∏è',color:'#1e88e5',primary:'Abi',swap:'Shailesh / Girish',mustDo:['Be the anchor - stay central','Win headers and aerial duels',"Be strong - don't let attackers turn",'Pass to CDM or fullbacks','Cover for fullbacks when they push up'],mustNot:["Don't dive in - stay on your feet","Don't push too high","Don't dribble into trouble"],tips:['Last line before GK - be calm','Organize the backline','When in doubt, clear it']},
    lb:{name:'Left Back',icon:'‚¨ÖÔ∏è',color:'#1e88e5',primary:'Unni',swap:'Aravind',mustDo:['Be physical - win 1v1 duels','Stay deep and protect your side','Pass to CDM - main outlet','Cover left flank, track wingers','Communicate with CB and LM'],mustNot:["Don't push too far forward in def mode","Don't let attackers behind you","Don't play risky passes across the back"],tips:['In attack, overlap with LM','If you go forward, CDM covers','Win headers on your side']},
    rb:{name:'Right Back',icon:'‚û°Ô∏è',color:'#1e88e5',primary:'Girish',swap:'Shailesh',mustDo:['Be physical - win 1v1 duels','Stay deep and protect your side','Pass to CDM - main outlet','Cover right flank, track wingers','Communicate with CB and RM'],mustNot:["Don't push too far forward in def mode","Don't let attackers behind you","Don't play risky passes across the back"],tips:['In attack, overlap with RM','If you go forward, CDM covers','Win headers on your side']},
    cdm:{name:'CDM',icon:'üî∞',color:'#ff9800',primary:'Arun',swap:'Ritz',mustDo:['Shield defense - sit deep','Receive from defenders and distribute','Intercept passes, break up attacks','Link defense and midfield','Win ball back and recycle'],mustNot:['NEVER go forward leaving defense exposed',"Don't chase ball all over pitch","Don't play risky through balls"],tips:['You are the screen','Keep it simple - pass and move','Read the game and anticipate']},
    lm:{name:'Left Midfielder',icon:'üèÉ',color:'#ff9800',primary:'Rithun',swap:'Jai',mustDo:['Support defense first - track back','Be flexible - find space','Play accurate passes','Create triangles with CDM & CM','In attack, go wide and high'],mustNot:["Don't stay too high without ball","Don't lose ball in dangerous areas","Don't ignore defensive duties"],tips:['Always be available for a pass','When LB has ball, show or make space','Make runs behind defenders in attack']},
    rm:{name:'Right Midfielder',icon:'üèÉ',color:'#ff9800',primary:'Sijo',swap:'Biju',mustDo:['Support defense first - track back','Be flexible - find space','Play accurate passes','Create triangles with CDM & CM','In attack, go wide and high'],mustNot:["Don't stay too high without ball","Don't lose ball in dangerous areas","Don't ignore defensive duties"],tips:['Always be available for a pass','When RB has ball, show or make space','Make runs behind defenders in attack']},
    cm:{name:'Central Midfielder',icon:'‚öôÔ∏è',color:'#ff9800',primary:'Sajas',swap:'Biju',mustDo:['Be the engine - link defense to attack','Find space, always be available','Play through balls to striker','Support press when we lose ball','Keep ball moving - simple passes'],mustNot:["Don't force difficult passes","Don't hold ball too long","Don't disappear - always be involved"],tips:['Drop deep or push forward as needed','You connect everyone - be the glue','When in doubt, play back to CDM']},
    st:{name:'Striker',icon:'‚öΩ',color:'#e53935',primary:'Jai',swap:'PK',mustDo:['Run into gaps behind defenders','Take shots - be confident','Press defenders - you start our defense!','Hold up ball, wait for support','Be the target for through passes'],mustNot:["Don't drop too deep","Don't stop moving","Don't chase lost causes - press smart"],tips:['When pressing, cut passing lanes','Make life miserable for their defenders','Celebrate every goal! üéâ']}
};

// ===== POSITIONS & ROTATIONS =====
const P0={
    defensive:{gk:{left:'8%',top:'50%'},cb:{left:'16%',top:'50%'},lb:{left:'20%',top:'25%'},rb:{left:'20%',top:'75%'},cdm:{left:'32%',top:'50%'},lm:{left:'48%',top:'22%'},rm:{left:'48%',top:'78%'},cm:{left:'58%',top:'50%'},st:{left:'78%',top:'50%'}},
    attack:{gk:{left:'8%',top:'50%'},cb:{left:'20%',top:'50%'},lb:{left:'30%',top:'20%'},rb:{left:'30%',top:'80%'},cdm:{left:'45%',top:'50%'},lm:{left:'65%',top:'15%'},rm:{left:'65%',top:'85%'},cm:{left:'72%',top:'50%'},st:{left:'88%',top:'50%'}}
};
const P1={
    defensive:{gk:{left:'8%',top:'50%'},cb:{left:'16%',top:'50%'},lb:{left:'24%',top:'25%'},rb:{left:'24%',top:'75%'},cdm:{left:'36%',top:'50%'},lm:{left:'50%',top:'22%'},rm:{left:'50%',top:'78%'},cm:{left:'60%',top:'50%'},st:{left:'78%',top:'50%'}},
    attack:{gk:{left:'8%',top:'50%'},cb:{left:'18%',top:'50%'},lb:{left:'32%',top:'20%'},rb:{left:'32%',top:'80%'},cdm:{left:'48%',top:'50%'},lm:{left:'68%',top:'15%'},rm:{left:'68%',top:'85%'},cm:{left:'72%',top:'50%'},st:{left:'88%',top:'50%'}}
};

const PS0=[{from:'gk',to:'lb'},{from:'lb',to:'cdm'},{from:'cdm',to:'rm'},{from:'rm',to:'cm'},{from:'cm',to:'lm'},{from:'lm',to:'st'},{from:'st',to:'cm'},{from:'cm',to:'cdm'}];
const PS1=[{from:'gk',to:'cb'},{from:'cb',to:'lb'},{from:'lb',to:'cdm'},{from:'cdm',to:'rm'},{from:'rm',to:'cm'},{from:'cm',to:'lm'},{from:'lm',to:'st'},{from:'st',to:'cm'},{from:'cm',to:'cb'}];

const R0=[
    {gk:{name:'Gerry',swap:'Sijo'},lb:{name:'Unni',swap:'Aravind'},rb:{name:'Girish',swap:'Shailesh'},cdm:{name:'Arun',swap:'Ritz'},lm:{name:'Rithun',swap:'Jai'},rm:{name:'Sijo',swap:'Biju'},cm:{name:'Sajas',swap:'Biju'},st:{name:'Jai',swap:'PK'}},
    {gk:{name:'Gerry',swap:'Sijo'},lb:{name:'Aravind',swap:'Unni'},rb:{name:'Shailesh',swap:'Girish'},cdm:{name:'Ritz',swap:'Arun'},lm:{name:'Rithun',swap:'Jai'},rm:{name:'Biju',swap:'Sijo'},cm:{name:'Sajas',swap:'Biju'},st:{name:'Jai',swap:'PK'}},
    {gk:{name:'Sijo',swap:'Gerry'},lb:{name:'Unni',swap:'Aravind'},rb:{name:'Girish',swap:'Shailesh'},cdm:{name:'Arun',swap:'Ritz'},lm:{name:'Jai',swap:'Rithun'},rm:{name:'Biju',swap:'Sijo'},cm:{name:'Sajas',swap:'Biju'},st:{name:'PK',swap:'Jai'}},
    {gk:{name:'Gerry',swap:'Sijo'},lb:{name:'Aravind',swap:'Unni'},rb:{name:'Girish',swap:'Shailesh'},cdm:{name:'Arun',swap:'Ritz'},lm:{name:'Rithun',swap:'Jai'},rm:{name:'Aju',swap:'Sijo'},cm:{name:'Biju',swap:'Sajas'},st:{name:'Manu',swap:'PK'}}
];
const R1=[
    {gk:{name:'Gerry',swap:'Sijo'},cb:{name:'Abi',swap:'Shailu/Girish'},lb:{name:'Unni',swap:'Aravind'},rb:{name:'Girish',swap:'Shailesh'},cdm:{name:'Arun',swap:'Ritz'},lm:{name:'Rithun',swap:'Jai'},rm:{name:'Sijo',swap:'Biju'},cm:{name:'Sajas',swap:'Biju'},st:{name:'Jai',swap:'PK'}},
    {gk:{name:'Gerry',swap:'Sijo'},cb:{name:'Shailesh',swap:'Abi'},lb:{name:'Aravind',swap:'Unni'},rb:{name:'Girish',swap:'Unni'},cdm:{name:'Ritz',swap:'Arun'},lm:{name:'Rithun',swap:'Jai'},rm:{name:'Biju',swap:'Sijo'},cm:{name:'Sajas',swap:'Biju'},st:{name:'Jai',swap:'PK'}},
    {gk:{name:'Sijo',swap:'Gerry'},cb:{name:'Girish',swap:'Abi'},lb:{name:'Aravind',swap:'Unni'},rb:{name:'Shailesh',swap:'Unni'},cdm:{name:'Arun',swap:'Ritz'},lm:{name:'Jai',swap:'Rithun'},rm:{name:'Biju',swap:'Sijo'},cm:{name:'Sajas',swap:'Biju'},st:{name:'PK',swap:'Jai'}},
    {gk:{name:'Gerry',swap:'Sijo'},cb:{name:'Abi',swap:'Shailu/Girish'},lb:{name:'Unni',swap:'Aravind'},rb:{name:'Girish',swap:'Shailesh'},cdm:{name:'Arun',swap:'Ritz'},lm:{name:'Rithun',swap:'Jai'},rm:{name:'Aju',swap:'Sijo'},cm:{name:'Biju',swap:'Sajas'},st:{name:'Manu',swap:'PK'}}
];

// ===== FUNCTIONS =====
function showPlayerGuide(pos){const g=playerGuides[pos];if(!g)return;document.getElementById('modalHeader').innerHTML=`<div class="player-icon" style="background:${g.color}">${g.icon}</div><h2>${g.name}</h2><span class="position-badge" style="background:${g.color}">${pos.toUpperCase()}</span>`;document.getElementById('modalBody').innerHTML=`<div class="guide-section"><h3>‚úÖ MUST DO</h3><ul>${g.mustDo.map(i=>`<li class="must-do">‚úÖ ${i}</li>`).join('')}</ul></div><div class="guide-section"><h3>‚ùå MUST NOT</h3><ul>${g.mustNot.map(i=>`<li class="must-not">‚ùå ${i}</li>`).join('')}</ul></div><div class="guide-section"><h3>üí° TIPS</h3><ul>${g.tips.map(i=>`<li class="tip">üí° ${i}</li>`).join('')}</ul></div><div class="swap-info"><strong>Primary:</strong> ${g.primary} | <strong>Swap:</strong> ${g.swap}</div>`;document.getElementById('modalOverlay').classList.add('active');}
function closeModal(e){if(e&&e.target!==e.currentTarget)return;document.getElementById('modalOverlay').classList.remove('active');}

function setFormation(f){currentFormation=f;currentRotation=0;document.querySelectorAll('.formation-btn').forEach(b=>b.classList.remove('active'));document.querySelector(`.formation-btn.${f}`).classList.add('active');if(f==='without-abi')document.getElementById('cb').classList.add('hidden');else document.getElementById('cb').classList.remove('hidden');updateNames((f==='without-abi'?R0:R1)[0]);currentMode==='defensive'?setDefensiveMode():setAttackMode();}
function updateNames(r){Object.keys(r).forEach(id=>{const p=document.getElementById(id);if(p){p.querySelector('.player-name').textContent=r[id].name;p.querySelector('.player-swap').textContent=`‚Üî ${r[id].swap}`;}});}
function getPos(){return currentFormation==='without-abi'?P0:P1;}
function setDefensiveMode(){currentMode='defensive';moveTo(getPos().defensive);document.getElementById('modeIndicator').textContent='DEFENSIVE';document.getElementById('modeIndicator').className='mode-badge mode-defensive';upBtn('defensive');}
function setAttackMode(){currentMode='attack';moveTo(getPos().attack);document.getElementById('modeIndicator').textContent='ATTACK';document.getElementById('modeIndicator').className='mode-badge mode-attack';upBtn('attack');}
function moveTo(c){Object.keys(c).forEach(id=>{const p=document.getElementById(id);if(p&&!p.classList.contains('hidden')){p.style.left=c[id].left;p.style.top=c[id].top;}});}
function upBtn(m){document.querySelectorAll('.btn').forEach(b=>b.classList.remove('active'));document.querySelector(m==='defensive'?'.btn-defensive':'.btn-attack').classList.add('active');}
function getCenter(id){const p=document.getElementById(id),f=document.querySelector('.field-inner'),r=f.getBoundingClientRect();return{x:(parseFloat(p.style.left)/100)*r.width,y:(parseFloat(p.style.top)/100)*r.height};}

async function showPassingPattern(){const b=document.getElementById('ball'),c=document.getElementById('passLines');c.innerHTML='';const s=currentFormation==='without-abi'?PS0:PS1;b.classList.add('visible');for(let i=0;i<s.length;i++){const pass=s[i],fp=document.getElementById(pass.from),tp=document.getElementById(pass.to);if(fp.classList.contains('hidden')||tp.classList.contains('hidden'))continue;const from=getCenter(pass.from),to=getCenter(pass.to);b.style.left=fp.style.left;b.style.top=fp.style.top;await sl(250);const line=document.createElement('div');line.className='pass-line';line.style.left=`${from.x}px`;line.style.top=`${from.y}px`;const dx=to.x-from.x,dy=to.y-from.y;line.style.width=`${Math.sqrt(dx*dx+dy*dy)}px`;line.style.transform=`rotate(${Math.atan2(dy,dx)*180/Math.PI}deg)`;c.appendChild(line);line.classList.add('active');b.style.left=tp.style.left;b.style.top=tp.style.top;await sl(400);}await sl(400);b.classList.remove('visible');c.innerHTML='';}

function showSubstitution(){const r=currentFormation==='without-abi'?R0:R1;currentRotation=(currentRotation+1)%r.length;const rot=r[currentRotation];Object.keys(rot).forEach(id=>{const p=document.getElementById(id);if(!p||p.classList.contains('hidden'))return;p.classList.add('subbing-out');setTimeout(()=>{p.querySelector('.player-name').textContent=rot[id].name;p.querySelector('.player-swap').textContent=`‚Üî ${rot[id].swap}`;p.classList.remove('subbing-out');p.classList.add('subbing-in');setTimeout(()=>p.classList.remove('subbing-in'),400);},400);});const n=currentFormation==='without-abi'?['Primary','Rotation A','Rotation B','Rot C (Manu/Aju)']:['Abi CB','Shailu CB','Girish CB','Rot C (Manu/Aju)'];document.getElementById('modeIndicator').textContent=n[currentRotation];}

function sl(ms){return new Promise(r=>setTimeout(r,ms));}
document.addEventListener('keydown',e=>{if(e.key==='Escape')closeModal();});

// Init
checkStorage().then(() => {
    setFormation('without-abi');
    setDefensiveMode();
    loadChat();
});

// Auto-refresh only if storage is available
setInterval(() => { if(storageAvailable) loadChat(); }, 8000);
</script>
</body>
</html>
